<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>YaYa Card Game</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c7744">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --table-color: #2c7744;
            --card-width: 80px;
            --card-height: 120px;
        }

        body {
            font-family: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
            background-color: #1a1a1a;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100dvh; 
            color: white;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        #game-board {
            flex-grow: 1;
            width: 100%;
            background-color: var(--table-color);
            background-image: radial-gradient(circle, #358f52 0%, #1e5230 100%);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            position: relative;
            
            border: 4px solid #1e5230;
            box-sizing: border-box;
            
            padding-bottom: env(safe-area-inset-bottom, 10px);
            margin-top: env(safe-area-inset-top, 0px);
            height: calc(100dvh - env(safe-area-inset-top, 0px));
            
            transition: border-color 0.5s;
        }

        /* --- ZONES --- */
        .cpu-area {
            width: 100%;
            height: 15%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
        }

        .middle-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 15px;
            min-height: 0;
            padding-top: 25px; 
        }

        .piles-row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        #game-log {
            width: 90%;
            max-width: 500px;
            height: 125px; 
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            font-size: 0.85rem;
            border-radius: 8px;
            font-family: monospace;
            pointer-events: auto;
            text-align: left;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            -webkit-overflow-scrolling: touch;
            margin-top: 5px;
        }
        
        .log-entry { margin-bottom: 3px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }

        .player-area {
            width: 100%;
            height: 35%;
            display: flex;
            align-items: center;
            padding: 10px 0;
            overflow-x: auto;
            justify-content: flex-start;
            gap: -10px;
            padding-left: 20px;
            padding-right: 20px;
            box-sizing: border-box;
        }
        .player-area::-webkit-scrollbar { display: none; }

        /* --- CARD DESIGN --- */
        .card {
            flex-shrink: 0;
            width: var(--card-width);
            height: var(--card-height);
            border-radius: 10px;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.4);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid white;
            box-sizing: border-box;
        }
        
        .card-inner {
            width: 100%; height: 100%;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .oval {
            background: white;
            width: 90%; height: 60%;
            border-radius: 50% 50%;
            transform: rotate(-30deg);
            position: absolute;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        .card-symbol {
            position: relative; z-index: 2;
            font-size: 2.5rem; font-weight: 900;
            text-shadow: 2px 2px 0px white, -1px -1px 0 white;
        }
        
        .corner-val {
            position: absolute; font-size: 0.8rem;
            font-weight: bold; color: white; padding: 2px;
        }
        .top-left { top: 2px; left: 4px; }
        .bot-right { bottom: 2px; right: 4px; transform: rotate(180deg); }

        .Red .card-inner { background: #ff5555; }
        .Red .card-symbol { color: #ff5555; }
        .Blue .card-inner { background: #0066ff; }
        .Blue .card-symbol { color: #0066ff; }
        .Green .card-inner { background: #55aa55; }
        .Green .card-symbol { color: #55aa55; }
        .Yellow .card-inner { background: #ffcc00; }
        .Yellow .card-symbol { color: #eebb00; }
        
        .Wild .card-inner, .wild4 .card-inner {
            background: conic-gradient(red, blue, green, yellow, red);
        }
        .Wild .card-symbol { color: black; text-shadow: 2px 2px 0 white; }

        .symbol-text { font-size: 1.2rem; transform: rotate(-15deg); }

        .card-back {
            background: linear-gradient(135deg, #000 25%, #222 25%, #222 50%, #000 50%, #000 75%, #222 75%, #222 100%);
            background-size: 20px 20px;
            width: 100%; height: 100%;
            border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid white;
        }
        .back-oval {
            background: #ff5555; color: yellow; font-weight: bold;
            padding: 5px 2px; width: 80%; text-align: center;
            border-radius: 50%; transform: rotate(-25deg);
            border: 2px solid white; font-size: 1.1rem;
            text-shadow: 1px 1px 0 #aa0000;
        }

        .player-area .card:active { transform: scale(0.95); }
        .card.disabled { filter: brightness(0.6); opacity: 0.8; }
        
        #turn-indicator {
            font-size: 1.2rem; font-weight: bold; 
            background: rgba(0,0,0,0.5);
            padding: 5px 15px; border-radius: 20px; 
            margin-bottom: 5px; text-transform: uppercase;
        }

        .uno-shout {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: yellow; font-size: 5rem; font-weight: 900;
            text-shadow: 4px 4px 0px red; display: none; z-index: 100;
        }

        #color-picker {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            justify-content: center; align-items: center; z-index: 200;
        }
        .picker-content { background: white; padding: 20px; border-radius: 15px; text-align: center; }
        .color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .color-btn { width: 60px; height: 60px; border-radius: 10px; border: none; }

        @media (max-width: 600px) {
            :root { --card-width: 65px; --card-height: 96px; }
            .piles-row { gap: 15px; }
        }
    </style>
</head>
<body>

    <div id="game-board">
        <div class="cpu-area" id="cpu-hand"></div>
        
        <div class="middle-section">
            <div id="turn-indicator">Loading...</div>
            <div class="piles-row">
                <div class="card" id="draw-deck" onclick="humanDraw()">
                    <div class="card-back"><div class="back-oval">YaYa</div></div>
                </div>
                <div id="discard-pile-container"></div>
            </div>
            <div id="game-log"></div>
        </div>

        <div class="player-area" id="player-hand"></div>
        <div id="uno-msg" class="uno-shout">YaYa!</div>
    </div>

    <div id="color-picker">
        <div class="picker-content">
            <h2 style="color:black; margin:0;">Pick Color</h2>
            <div class="color-grid">
                <button class="color-btn" style="background:#ff5555" onclick="resolveWild('Red')"></button>
                <button class="color-btn" style="background:#0066ff" onclick="resolveWild('Blue')"></button>
                <button class="color-btn" style="background:#55aa55" onclick="resolveWild('Green')"></button>
                <button class="color-btn" style="background:#ffcc00" onclick="resolveWild('Yellow')"></button>
            </div>
        </div>
    </div>

<script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(req => console.log('Service Worker Registered!'))
                .catch(err => console.log('Service Worker Failed', err));
        });
    }

    const COLORS = ['Red', 'Blue', 'Green', 'Yellow'];
    let deck = [], discardPile = [], playerHand = [], cpuHand = [];
    let currentColor = '', currentSymbol = '', isPlayerTurn = true, gameActive = true, hasDrawnThisTurn = false; 

    const logEl = document.getElementById('game-log');
    const turnEl = document.getElementById('turn-indicator');
    const unoMsg = document.getElementById('uno-msg');
    const discardContainer = document.getElementById('discard-pile-container');

    function initGame() {
        createDeck();
        shuffleDeck();
        dealCards();
        
        let firstCard = drawFromDeck();
        while (firstCard.type === 'wild' || firstCard.type === 'wild4') {
            deck.push(firstCard);
            shuffleDeck();
            firstCard = drawFromDeck();
        }
        
        playCardToPile(firstCard, false);
        renderGame();
        log("Welcome to YaYa!");
        updateTurnIndicator();
    }

    function createDeck() {
        deck = [];
        COLORS.forEach(color => {
            deck.push(createCard(color, '0', 'number'));
            for (let i = 1; i <= 9; i++) {
                deck.push(createCard(color, i.toString(), 'number'));
                deck.push(createCard(color, i.toString(), 'number'));
            }
            ['Skip', 'Reverse', 'Draw2'].forEach(type => {
                deck.push(createCard(color, type, 'action'));
                deck.push(createCard(color, type, 'action'));
            });
        });
        for(let i=0; i<4; i++) {
            deck.push(createCard('Wild', 'Wild', 'wild'));
            deck.push(createCard('Wild', 'Draw4', 'wild4'));
        }
    }

    function createCard(color, value, type) {
        return {
            id: Math.random().toString(36).substr(2, 9),
            color: color, value: value, type: type
        };
    }

    function shuffleDeck() {
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    function drawFromDeck() {
        if (deck.length === 0) {
            if (discardPile.length > 1) {
                const topCard = discardPile.pop();
                deck = discardPile;
                discardPile = [topCard];
                shuffleDeck();
                log("Shuffling...");
            } else {
                log("Empty Deck!");
                return null;
            }
        }
        return deck.pop();
    }

    function dealCards() {
        for(let i=0; i<7; i++) {
            playerHand.push(drawFromDeck());
            cpuHand.push(drawFromDeck());
        }
    }

    function isPlayable(card) {
        if (card.type === 'wild' || card.type === 'wild4') return true;
        if (card.color === currentColor) return true;
        if (card.value === currentSymbol) return true;
        return false;
    }

    function playCardToPile(card, triggerEffects = true) {
        discardPile.push(card);
        currentColor = card.color;
        currentSymbol = card.value;
        
        discardContainer.innerHTML = '';
        discardContainer.appendChild(renderCardHTML(card, false));

        if (triggerEffects) {
            handleSpecialEffects(card);
        }
    }

    function renderCardHTML(card, isClickable = true) {
        const el = document.createElement('div');
        el.className = `card ${card.color} ${card.type}`;
        
        let displayVal = card.value;
        let isSymbol = false;

        if(card.value === 'Draw2') { displayVal = '+2'; isSymbol=true; }
        if(card.value === 'Draw4') { displayVal = '+4'; isSymbol=true; }
        if(card.value === 'Skip') { displayVal = '⊘'; isSymbol=true; }
        if(card.value === 'Reverse') { displayVal = '⇄'; isSymbol=true; }
        if(card.value === 'Wild') { displayVal = '?'; isSymbol=true; }

        const innerClass = isSymbol ? 'card-symbol symbol-text' : 'card-symbol';

        el.innerHTML = `
            <div class="card-inner">
                <div class="oval"></div>
                <div class="${innerClass}">${displayVal}</div>
                <div class="corner-val top-left">${displayVal}</div>
                <div class="corner-val bot-right">${displayVal}</div>
            </div>
        `;
        return el;
    }

    function handleSpecialEffects(card) {
        if (playerHand.length === 0 || cpuHand.length === 0) {
            setTimeout(checkWinCondition, 200);
            return;
        }

        let extraTurn = false;
        if (card.value === 'Skip' || card.value === 'Reverse') {
            log(`${isPlayerTurn ? 'You' : 'CPU'} Skip!`);
            extraTurn = true;
        }
        else if (card.value === 'Draw2') {
            const targetHand = isPlayerTurn ? cpuHand : playerHand;
            targetHand.push(drawFromDeck());
            targetHand.push(drawFromDeck());
            renderGame();
            log("Draw 2 + Skip.");
            extraTurn = true;
        }
        else if (card.type === 'wild' || card.type === 'wild4') {
            gameActive = false;
            if (isPlayerTurn) {
                document.getElementById('color-picker').style.display = 'flex';
            } else {
                resolveWild(getCpuBestColor());
            }
            return;
        }

        if (extraTurn) {
            hasDrawnThisTurn = false;
            updateTurnIndicator();
            if (!isPlayerTurn && gameActive) setTimeout(cpuTurn, 1500);
            return;
        }
        switchTurn();
    }

    function resolveWild(color) {
        currentColor = color;
        log(`Color: ${color}`);
        document.getElementById('color-picker').style.display = 'none';
        
        const topEl = discardContainer.firstElementChild;
        if(topEl) {
            topEl.className = `card ${color}`;
        }

        const topCard = discardPile[discardPile.length - 1];
        if (topCard.type === 'wild4') {
            if (playerHand.length === 0 || cpuHand.length === 0) {
                setTimeout(checkWinCondition, 200);
                return;
            }

            const targetHand = isPlayerTurn ? cpuHand : playerHand;
            for(let i=0; i<4; i++) targetHand.push(drawFromDeck());
            log("Draw 4 + Skip!");
            renderGame();
            
            gameActive = true;
            hasDrawnThisTurn = false;
            updateTurnIndicator();
            if (!isPlayerTurn && gameActive) setTimeout(cpuTurn, 1500);
            return; 
        }
        gameActive = true;
        switchTurn();
    }

    function switchTurn() {
        if(!gameActive) return;
        isPlayerTurn = !isPlayerTurn;
        hasDrawnThisTurn = false;
        updateTurnIndicator();
        renderGame();
        if (!isPlayerTurn) setTimeout(cpuTurn, 1500);
    }

    function checkWinCondition() {
        if (playerHand.length === 1) showUno('Player');
        if (cpuHand.length === 1) showUno('CPU');

        if (playerHand.length === 0) {
            log("YOU WIN!");
            alert("YOU WIN!");
            gameActive = false;
        } else if (cpuHand.length === 0) {
            log("CPU WINS!");
            alert("CPU WINS!");
            gameActive = false;
        }
    }

    function showUno(who) {
        unoMsg.style.display = 'block';
        unoMsg.innerText = `${who} YaYa!`;
        setTimeout(() => unoMsg.style.display = 'none', 2000);
    }

    function humanPlayCard(index) {
        if (!isPlayerTurn || !gameActive) return;
        const card = playerHand[index];
        if (isPlayable(card)) {
            playerHand.splice(index, 1);
            renderGame();
            playCardToPile(card);
        } else log("Can't play that.");
    }

    function humanDraw() {
        if (!isPlayerTurn || !gameActive) return;
        if (hasDrawnThisTurn) { switchTurn(); return; }

        const newCard = drawFromDeck();
        if (newCard) {
            playerHand.push(newCard);
            renderGame();
            const pHand = document.getElementById('player-hand');
            pHand.scrollLeft = pHand.scrollWidth;

            if (isPlayable(newCard)) {
                log("Drew playable card.");
                hasDrawnThisTurn = true;
                updateTurnIndicator();
            } else {
                log("Drew card. No moves.");
                setTimeout(switchTurn, 1000);
            }
        }
    }

    function cpuTurn() {
        if (!gameActive) return;
        const playable = cpuHand.filter(c => isPlayable(c));
        if (playable.length > 0) playCpuBestOption(playable);
        else {
            const newCard = drawFromDeck();
            if(newCard) {
                cpuHand.push(newCard);
                if (isPlayable(newCard)) {
                    log("CPU plays drawn card!");
                    setTimeout(() => playCpuBestOption([newCard]), 1000);
                } else {
                    log("CPU Passes");
                    setTimeout(switchTurn, 1000);
                }
            } else setTimeout(switchTurn, 1000);
        }
    }

    function playCpuBestOption(playable) {
        playable.sort((a,b) => (a.type === 'action' || a.type === 'wild4') ? -1 : 0);
        const chosen = playable[0];
        cpuHand.splice(cpuHand.indexOf(chosen), 1);
        renderGame();
        playCardToPile(chosen);
    }

    function getCpuBestColor() {
        const counts = { Red:0, Blue:0, Green:0, Yellow:0 };
        cpuHand.forEach(c => { if (COLORS.includes(c.color)) counts[c.color]++; });
        return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    }

    function renderGame() {
        const pHandEl = document.getElementById('player-hand');
        const cHandEl = document.getElementById('cpu-hand');
        
        pHandEl.innerHTML = '';
        playerHand.forEach((card, index) => {
            const el = renderCardHTML(card);
            if (isPlayerTurn && !isPlayable(card)) el.classList.add('disabled');
            el.onclick = () => humanPlayCard(index);
            pHandEl.appendChild(el);
        });

        cHandEl.innerHTML = '';
        cpuHand.forEach(() => {
            const el = document.createElement('div');
            el.className = 'card';
            el.style.transform = 'scale(0.8)';
            el.innerHTML = `<div class="card-back"><div class="back-oval">YaYa</div></div>`;
            cHandEl.appendChild(el);
        });
        
        if (isPlayerTurn && hasDrawnThisTurn) turnEl.innerText = "Play or Pass";
    }

    function updateTurnIndicator() {
        if (!hasDrawnThisTurn) turnEl.innerText = isPlayerTurn ? "Your Turn" : "CPU Turn";
        turnEl.style.color = isPlayerTurn ? "#44ff44" : "#ff4444";
        
        const board = document.getElementById('game-board');
        const borderColor = 
            currentColor === 'Red' ? '#aa0000' :
            currentColor === 'Blue' ? '#0000aa' :
            currentColor === 'Green' ? '#00aa00' :
            currentColor === 'Yellow' ? '#aaaa00' : '#2c7744';
            
        board.style.borderColor = borderColor;
    }

    function log(msg) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerText = `> ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    window.onload = initGame;
</script>
</body>
</html>